// Exemplo de integra√ß√£o no bot principal para tratar respostas de sugest√µes
// ========================================================================

const OPENAI = require('../open_ai/open_ai');

class BotWithSuggestionHandling {
    constructor() {
        this.openai = new OPENAI(process.env.OPENAI_API_KEY);
        this.userContexts = new Map();
    }

    // M√©todo principal para detectar e processar sugest√µes
    async processMessage(userId, message, weatherData = null) {
        try {
            console.log(`üì® Processando mensagem de ${userId}: "${message}"`);

            const userContext = this.getUserContext(userId);

            // 1. Verificar se √© uma resposta a sugest√£o
            if (this.isSuggestionResponse(message, userContext)) {
                console.log('üéØ Detectada resposta de sugest√£o');
                return await this.handleSuggestionResponse(userId, message, weatherData);
            }

            // 2. Processamento normal da mensagem
            return await this.handleNormalMessage(userId, message, weatherData);

        } catch (error) {
            console.error('‚ùå Erro ao processar mensagem:', error.message);
            return this.createErrorResponse(error.message);
        }
    }

    // Verificar se a mensagem √© uma resposta de sugest√£o
    isSuggestionResponse(message, userContext) {
        // Verificar se foi uma sugest√£o enviada recentemente
        const recentSuggestions = userContext.recentSuggestions || [];

        // Lista de padr√µes comuns de sugest√µes
        const suggestionPatterns = [
            "h√° alguma atividade",
            "atividades hoje",
            "que roupa usar",
            "dicas calor",
            "dicas frio",
            "dicas chuva",
            "tempo amanh√£",
            "previs√£o 7 dias",
            "vai chover",
            "comparar cidades",
            "ajuda",
            "onde ir",
            "o que fazer"
        ];

        const lowerMessage = message.toLowerCase().trim();

        // Verificar se corresponde a sugest√µes recentes
        if (recentSuggestions.includes(lowerMessage)) {
            return true;
        }

        // Verificar se corresponde a padr√µes de sugest√£o
        return suggestionPatterns.some(pattern =>
            lowerMessage.includes(pattern) ||
            this.calculateSimilarity(lowerMessage, pattern) > 0.8
        );
    }

    // Processar resposta de sugest√£o
    async handleSuggestionResponse(userId, suggestionText, weatherData) {
        try {
            console.log(`üéØ Processando resposta de sugest√£o: "${suggestionText}"`);

            const userContext = this.getUserContext(userId);

            // Buscar dados meteorol√≥gicos se necess√°rio
            if (!weatherData) {
                weatherData = await this.fetchCurrentWeatherData(userContext.lastCity || 'maputo');
            }

            // Processar com o sistema especializado
            const result = await this.openai.processSuggestionResponse(
                suggestionText,
                weatherData,
                userContext
            );

            // Atualizar contexto do usu√°rio
            this.updateUserContextAfterSuggestion(userId, suggestionText, result);

            // Preparar resposta final
            const response = {
                type: 'suggestion_response',
                message: result.response,
                suggestions: result.suggestions,
                suggestionType: result.suggestionType,
                success: result.success,
                originalSuggestion: suggestionText
            };

            console.log('‚úÖ Resposta de sugest√£o processada:', {
                type: result.suggestionType,
                responseLength: result.response.length,
                newSuggestions: result.suggestions.length
            });

            return response;

        } catch (error) {
            console.error('‚ùå Erro ao processar resposta de sugest√£o:', error.message);
            return this.createSuggestionErrorResponse(suggestionText, error.message);
        }
    }

    // Processar mensagem normal (n√£o sugest√£o)
    async handleNormalMessage(userId, message, weatherData) {
        console.log('üìù Processando como mensagem normal');

        const userContext = this.getUserContext(userId);

        // An√°lise normal da mensagem
        const analysis = await this.openai.analyzeUserMessage(message, userContext);

        if (!analysis.success) {
            return this.createErrorResponse("Erro ao analisar mensagem");
        }

        // Buscar dados meteorol√≥gicos se necess√°rio
        if (!weatherData && analysis.analysis.type === 'weather_data') {
            weatherData = await this.fetchCurrentWeatherData(analysis.analysis.city);
        }

        // Gerar resposta contextual
        const response = await this.openai.generateContextualResponse(
            analysis.analysis,
            weatherData,
            userContext
        );

        // Gerar sugest√µes normais
        const suggestions = await this.openai.generateIntelligentSuggestions(
            analysis.analysis,
            weatherData,
            userContext
        );

        // Atualizar contexto
        this.updateUserContextAfterNormalMessage(userId, analysis.analysis, weatherData, suggestions);

        return {
            type: 'normal_response',
            message: response.response,
            suggestions: suggestions,
            analysis: analysis.analysis,
            success: true
        };
    }

    // ========================================
    // CASOS DE USO ESPEC√çFICOS
    // ========================================

    // Simular o caso problem√°tico original
    async simulateProblematicCase() {
        console.log('\nüîç SIMULANDO CASO PROBLEM√ÅTICO ORIGINAL');
        console.log('=====================================\n');

        const userId = 'test_user_258846151124';
        const suggestionText = "H√° alguma atividade";

        console.log(`üë§ Usu√°rio: ${userId}`);
        console.log(`üí¨ Mensagem: "${suggestionText}"`);
        console.log('üå§Ô∏è Contexto: Beira, 28¬∞C, c√©u claro\n');

        // Dados meteorol√≥gicos da Beira
        const weatherData = {
            city: "Beira",
            temperature: "28",
            description: "c√©u claro",
            humidity: "65",
            isForecast: false
        };

        // Processar com o novo sistema
        const result = await this.processMessage(userId, suggestionText, weatherData);

        console.log('üìä RESULTADO:');
        console.log('=============');
        console.log(`‚úÖ Tipo: ${result.type}`);
        console.log(`üìã Categoria: ${result.suggestionType || 'N/A'}`);
        console.log(`üìù Resposta: ${result.message.substring(0, 200)}...`);
        console.log(`üí° Novas sugest√µes: ${result.suggestions.join(', ')}`);
        console.log(`üéØ Sucesso: ${result.success}`);

        // Verificar se o problema foi resolvido
        const isFixed = result.suggestionType === 'practical_tips_activities' &&
            !result.message.includes('Lembrete Configurado') &&
            result.message.includes('Atividades');

        console.log(`\n${isFixed ? '‚úÖ' : '‚ùå'} PROBLEMA ${isFixed ? 'RESOLVIDO' : 'AINDA EXISTE'}!`);

        if (isFixed) {
            console.log('üéâ O sistema agora interpreta corretamente a consulta sobre atividades!');
        } else {
            console.log('‚ö†Ô∏è O sistema ainda n√£o est√° interpretando corretamente.');
        }

        return { isFixed, result };
    }

    // Demonstrar diferentes tipos de sugest√µes sendo tratadas corretamente
    async demonstrateVariousSuggestions() {
        console.log('\nüé≠ DEMONSTRA√á√ÉO DE DIFERENTES SUGEST√ïES');
        console.log('=====================================\n');

        const userId = 'demo_user';
        const weatherScenarios = [
            {
                name: "Dia normal",
                weather: { city: "Maputo", temperature: "26", description: "parcialmente nublado" }
            },
            {
                name: "Calor extremo",
                weather: { city: "Tete", temperature: "38", description: "sol intenso" }
            },
            {
                name: "Chuva",
                weather: { city: "Beira", temperature: "22", description: "chuva moderada" }
            },
            {
                name: "Frio",
                weather: { city: "Maputo", temperature: "14", description: "nublado" }
            }
        ];

        const suggestions = [
            "H√° alguma atividade",
            "Que roupa usar?",
            "Dicas calor",
            "Vai chover?",
            "Tempo amanh√£?"
        ];

        for (const scenario of weatherScenarios) {
            console.log(`üå§Ô∏è Cen√°rio: ${scenario.name} (${scenario.weather.city}, ${scenario.weather.temperature}¬∞C)`);

            for (const suggestion of suggestions) {
                const result = await this.processMessage(userId, suggestion, scenario.weather);
                console.log(`   "${suggestion}" ‚Üí ${result.suggestionType} (${result.success ? 'OK' : 'ERRO'})`);
            }
            console.log('');
        }
    }

    // ========================================
    // GEST√ÉO DE CONTEXTO
    // ========================================

    getUserContext(userId) {
        if (!this.userContexts.has(userId)) {
            this.userContexts.set(userId, {
                queryCount: 0,
                lastCity: null,
                preferredCity: null,
                expertiseLevel: "basic",
                conversationHistory: [],
                recentSuggestions: [],
                lastInteraction: Date.now()
            });
        }
        return this.userContexts.get(userId);
    }

    updateUserContextAfterSuggestion(userId, suggestionText, result) {
        const context = this.getUserContext(userId);

        // Adicionar sugest√£o ao hist√≥rico
        context.recentSuggestions = context.recentSuggestions || [];
        context.recentSuggestions.push(suggestionText.toLowerCase());

        // Manter apenas √∫ltimas 5 sugest√µes
        if (context.recentSuggestions.length > 5) {
            context.recentSuggestions = context.recentSuggestions.slice(-5);
        }

        // Atualizar estat√≠sticas
        context.queryCount += 1;
        context.lastInteraction = Date.now();

        // Armazenar novas sugest√µes para pr√≥xima detec√ß√£o
        if (result.suggestions) {
            context.recentSuggestions.push(...result.suggestions.map(s => s.toLowerCase()));
        }
    }

    updateUserContextAfterNormalMessage(userId, analysis, weatherData, suggestions) {
        const context = this.getUserContext(userId);

        context.queryCount += 1;
        context.lastInteraction = Date.now();

        if (analysis.city) {
            context.lastCity = analysis.city;
        }

        // Armazenar sugest√µes para detec√ß√£o futura
        if (suggestions) {
            context.recentSuggestions = suggestions.map(s => s.toLowerCase());
        }
    }

    // ========================================
    // M√âTODOS AUXILIARES
    // ========================================

    calculateSimilarity(str1, str2) {
        // Algoritmo simples de similaridade (Dice coefficient)
        const bigrams1 = this.getBigrams(str1);
        const bigrams2 = this.getBigrams(str2);

        const intersection = bigrams1.filter(bigram => bigrams2.includes(bigram));
        return (2 * intersection.length) / (bigrams1.length + bigrams2.length);
    }

    getBigrams(str) {
        const bigrams = [];
        for (let i = 0; i < str.length - 1; i++) {
            bigrams.push(str.substring(i, i + 2));
        }
        return bigrams;
    }

    async fetchCurrentWeatherData(city) {
        // Simula√ß√£o - substituir pela API real
        return {
            city: city,
            temperature: "26",
            description: "parcialmente nublado",
            humidity: "70",
            isForecast: false
        };
    }

    createErrorResponse(message) {
        return {
            type: 'error',
            message: `‚ùå ${message}`,
            suggestions: ["Ajuda", "Tentar novamente", "Comandos"],
            success: false
        };
    }

    createSuggestionErrorResponse(suggestionText, error) {
        return {
            type: 'suggestion_error',
            message: `‚ùå Erro ao processar "${suggestionText}": ${error}`,
            suggestions: ["Tentar novamente", "Ajuda", "Outras op√ß√µes"],
            success: false,
            originalSuggestion: suggestionText
        };
    }

    // ========================================
    // DEMONSTRA√á√ÉO COMPLETA
    // ========================================

    async runCompleteDemo() {
        console.log('\nüöÄ DEMONSTRA√á√ÉO COMPLETA DO SISTEMA');
        console.log('===================================\n');

        // 1. Simular o caso problem√°tico
        console.log('1Ô∏è‚É£ Simulando caso problem√°tico original...');
        const problematicResult = await this.simulateProblematicCase();

        // 2. Demonstrar v√°rias sugest√µes
        console.log('\n2Ô∏è‚É£ Demonstrando tratamento de v√°rias sugest√µes...');
        await this.demonstrateVariousSuggestions();

        // 3. Teste de performance
        console.log('\n3Ô∏è‚É£ Teste de performance...');
        const startTime = Date.now();

        for (let i = 0; i < 10; i++) {
            await this.processMessage('perf_test', 'H√° alguma atividade', {
                city: "Maputo", temperature: "25", description: "ensolarado"
            });
        }

        const endTime = Date.now();
        const avgTime = (endTime - startTime) / 10;
        console.log(`‚è±Ô∏è Tempo m√©dio por processamento: ${avgTime.toFixed(2)}ms`);

        // 4. Resumo
        console.log('\nüìã RESUMO');
        console.log('=========');
        console.log(`‚úÖ Problema original: ${problematicResult.isFixed ? 'RESOLVIDO' : 'PENDENTE'}`);
        console.log(`üìä Performance: ${avgTime < 50 ? 'EXCELENTE' : avgTime < 100 ? 'BOA' : 'ACEIT√ÅVEL'}`);
        console.log(`üéØ Sistema funcionando: ${problematicResult.result.success ? 'SIM' : 'N√ÉO'}`);

        return {
            problemFixed: problematicResult.isFixed,
            averageTime: avgTime,
            systemWorking: problematicResult.result.success
        };
    }
}

// Exportar classe
module.exports = BotWithSuggestionHandling;

// Executar demonstra√ß√£o se chamado diretamente
if (require.main === module) {
    const bot = new BotWithSuggestionHandling();
    bot.runCompleteDemo()
        .then(result => {
            console.log('\nüéâ Demonstra√ß√£o conclu√≠da!');
            console.log('Resultado:', result);
        })
        .catch(console.error);
}
